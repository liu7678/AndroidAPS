name: AAPS CI

on:
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Select Build Variant'
        required: true
        default: 'fullRelease'
        type: choice
        options:
          - fullRelease
          - fullDebug
          - aapsclientRelease
          - aapsclientDebug
          - aapsclient2Release
          - aapsclient2Debug
          - pumpcontrolRelease
          - pumpcontrolDebug

jobs:
  build:
    name: Build AAPS
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€æŸ¥å¹¶åŠ è½½ç­¾åå¯†é’¥åˆ°ç¯å¢ƒå˜é‡
      - name: Load Signing Secrets
        run: |
          echo "ğŸ” Loading signing secrets..."
          echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "::add-mask::$STORE_PASSWORD"
          echo "::add-mask::$KEY_ALIAS"
          echo "::add-mask::$KEY_PASSWORD"

      # 2. æ£€æŸ¥å¿…è¦å¯†é’¥æ˜¯å¦å­˜åœ¨
      - name: Check Secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          MISSING=0
          check_secret() {
            if [ -z "$1" ]; then
              echo "âŒ Missing secret: $2"
              MISSING=1
            fi
          }
          check_secret "$STORE_PASSWORD" "STORE_PASSWORD"
          check_secret "$KEY_ALIAS" "KEY_ALIAS"
          check_secret "$KEY_PASSWORD" "KEY_PASSWORD"
          if [ "$MISSING" -eq 1 ]; then
            echo "ğŸ›‘ Missing required secrets. Stopping build."
            exit 1
          fi
          echo "âœ… All required secrets are present."

      # 3. è·å–æºä»£ç 
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 4. éªŒè¯ keystore æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
      - name: Validate keystore file exists
        run: |
          KEYS_FILE="keystore/myrelease.jks"
          if [ ! -f "$KEYS_FILE" ]; then
            echo "âŒ Keystore file not found: $KEYS_FILE"
            exit 1
          fi
          chmod 600 "$KEYS_FILE"
          echo "âœ… Keystore file found: $KEYS_FILE"

      # 5. ã€å…³é”®ä¿®æ”¹ã€‘ç”¨ keytool -list éªŒè¯å¯†é’¥åº“ï¼ˆç²¾å‡†æ¨¡æ‹Ÿ Gradle è¡Œä¸ºï¼‰
      - name: Validate Keystore with keytool
        run: |
          echo "ğŸ” Validating keystore, alias and password using keytool (Gradle-compatible)..."
          echo "Current settings:"
          echo "  KEY_ALIAS = $KEY_ALIAS"
          echo "  STORE_PASSWORD length = ${#STORE_PASSWORD}"
          echo "  KEY_PASSWORD length = ${#KEY_PASSWORD}"

          # ä½¿ç”¨ keytool -list æµ‹è¯•æ˜¯å¦èƒ½è¯»å–æŒ‡å®šåˆ«åçš„å¯†é’¥
          if keytool -list -v -keystore "keystore/myrelease.jks" \
             -storepass "$STORE_PASSWORD" \
             -keypass "$KEY_PASSWORD" \
             -alias "$KEY_ALIAS" > /dev/null 2>&1; then
            echo "âœ… éªŒè¯æˆåŠŸï¼šå¯†é’¥åº“ã€åˆ«åå’Œå¯†ç å‡æœ‰æ•ˆï¼ˆGradle å¯è¯»ï¼‰ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š"
            echo "   1. STORE_PASSWORD å’Œ KEY_PASSWORD æ˜¯å¦ä¸ç”Ÿæˆ .jks æ—¶è¾“å…¥çš„ä¸€è‡´"
            echo "   2. KEY_ALIAS æ˜¯å¦ä¸ keytool -list æ˜¾ç¤ºçš„å®Œå…¨ç›¸åŒï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰"
            echo "   3. æ˜¯å¦åœ¨ç”Ÿæˆ .jks æ—¶è®¾ç½®äº†ä¸åŒçš„ç§é’¥å¯†ç "
            exit 1
          fi

      # 6. è®¾ç½® JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 7. ä¸º gradlew æ·»åŠ æ‰§è¡Œæƒé™
      - name: Make gradlew Executable
        run: chmod +x gradlew

      # 8. æ„å»º APK
      - name: Build APKs
        run: |
          echo "å¼€å§‹æ„å»ºç­¾åAPK..."
          ./gradlew :app:assemble${{ github.event.inputs.buildVariant }} :wear:assemble${{ github.event.inputs.buildVariant }} \
            -Pandroid.injected.signing.store.file="${PWD}/keystore/myrelease.jks" \
            -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD" \
            --no-daemon \
            --configure-on-demand \
            --stacktrace
          echo "âœ… APK æ„å»ºå®Œæˆã€‚"

      # 9. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¿®å¤ï¼šä½¿ç”¨ buildVariant å‘½åï¼Œé¿å…æœªå®šä¹‰å˜é‡ï¼‰
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aaps-apks-${{ github.event.inputs.buildVariant }}
          path: |
            app/build/outputs/apk/
            wear/build/outputs/apk/
          retention-days: 7
