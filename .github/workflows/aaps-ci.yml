name: AAPS CI

on:
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Select Build Variant'
        required: true
        default: 'fullRelease'
        type: choice
        options:
          - fullRelease
          - fullDebug
          - aapsclientRelease
          - aapsclientDebug
          - aapsclient2Release
          - aapsclient2Debug
          - pumpcontrolRelease
          - pumpcontrolDebug

jobs:
  build:
    name: Build AAPS
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€æŸ¥å¹¶åŠ è½½ç­¾åå¯†é’¥åˆ°ç¯å¢ƒå˜é‡
      - name: Load Signing Secrets
        run: |
          echo "ğŸ” Loading signing secrets..."
          echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "::add-mask::$STORE_PASSWORD"
          echo "::add-mask::$KEY_ALIAS"
          echo "::add-mask::$KEY_PASSWORD"

      # 2. æ£€æŸ¥å¿…è¦å¯†é’¥æ˜¯å¦å­˜åœ¨
      - name: Check Secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          MISSING=0
          check_secret() {
            if [ -z "$1" ]; then
              echo "âŒ Missing secret: $2"
              MISSING=1
            fi
          }
          check_secret "$STORE_PASSWORD" "STORE_PASSWORD"
          check_secret "$KEY_ALIAS" "KEY_ALIAS"
          check_secret "$KEY_PASSWORD" "KEY_PASSWORD"
          if [ "$MISSING" -eq 1 ]; then
            echo "ğŸ›‘ Missing required secrets. Stopping build."
            exit 1
          fi
          echo "âœ… All required secrets are present."

      # 3. è·å–æºä»£ç 
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 4. éªŒè¯ keystore æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
      - name: Validate keystore file exists
        run: |
          KEYS_FILE="keystore/myrelease.jks"
          if [ ! -f "$KEYS_FILE" ]; then
            echo "âŒ Keystore file not found: $KEYS_FILE"
            exit 1
          fi
          chmod 600 "$KEYS_FILE"
          echo "âœ… Keystore file found: $KEYS_FILE"

      # 5. éªŒè¯ç­¾åä¿¡æ¯æ˜¯å¦æ­£ç¡®
      - name: Validate Keystore and Credentials
        run: |
          echo "ğŸ” Validating keystore, alias and password..."
          echo "test" > dummy.txt
          zip -q dummy.jar dummy.txt
          rm dummy.txt

          if jarsigner -verify -verbose -keystore "keystore/myrelease.jks" \
             -storepass "$STORE_PASSWORD" \
             -keypass "$KEY_PASSWORD" \
             dummy.jar "$KEY_ALIAS"; then
            echo "âœ… éªŒè¯æˆåŠŸï¼šå¯†é’¥åº“ã€åˆ«åå’Œå¯†ç å‡æœ‰æ•ˆã€‚"
            rm -f dummy.jar
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šè¯·æ£€æŸ¥ STORE_PASSWORD, KEY_PASSWORD, KEY_ALIAS æ˜¯å¦æ­£ç¡®ã€‚"
            rm -f dummy.jar
            exit 1
          fi

      # 6. è®¾ç½® JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 7. ä¸º gradlew æ·»åŠ æ‰§è¡Œæƒé™
      - name: Make gradlew Executable
        run: chmod +x gradlew

      # 8. æ„å»º APK
      - name: Build APKs
        run: |
          echo "å¼€å§‹æ„å»ºç­¾åAPK..."
          ./gradlew :app:assemble${{ github.event.inputs.buildVariant }} :wear:assemble${{ github.event.inputs.buildVariant }} \
            -Pandroid.injected.signing.store.file="keystore/myrelease.jks" \
            -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          echo "âœ… APK æ„å»ºå®Œæˆã€‚"

      # 9. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aaps-apks-${{ env.VERSION }}${{ env.VERSION_SUFFIX }}
          path: |
            app/build/outputs/apk/
            wear/build/outputs/apk/
          retention-days: 7
