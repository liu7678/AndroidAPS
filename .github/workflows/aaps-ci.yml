name: AAPS CI - Build Only

on:
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Select Build Variant'
        required: true
        default: 'fullRelease'
        type: choice
        options:
          - fullRelease
          - fullDebug
          - aapsclientRelease
          - aapsclientDebug
          - aapsclient2Release
          - aapsclient2Debug
          - pumpcontrolRelease
          - pumpcontrolDebug

jobs:
  build:
    name: Build and Sign APKs
    runs-on: ubuntu-latest
    steps:
      # 1. 检查并加载签名密钥到环境变量
      - name: Load Secrets into Environment
        run: |
          echo "检查必要的密钥..."
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "❌ 错误：密钥 KEYSTORE_BASE64 未设置。请到 Settings > Secrets 中配置。"
            exit 1
          fi
          if [ -z "${{ secrets.STORE_PASSWORD }}" ]; then
            echo "❌ 错误：密钥 STORE_PASSWORD 未设置。"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "❌ 错误：密钥 KEY_ALIAS 未设置。"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "❌ 错误：密钥 KEY_PASSWORD 未设置。"
            exit 1
          fi

          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEYSTORE_BASE64=${{ secrets.KEYSTORE_BASE64 }}" >> $GITHUB_ENV
          echo "✅ 所有密钥已加载到环境变量中。"

      # 2. 获取源代码
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 3. 设置 Java 开发环境
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 4. 在项目目录中解码并创建 keystore/demokeystore.jks 文件
      - name: Decode Keystore and Create Required File
        run: |
          echo "正在解码密钥库文件并放置到项目目录..."
          mkdir -p ./keystore
          echo "$KEYSTORE_BASE64" | base64 -d > ./keystore/demokeystore.jks
          chmod 600 ./keystore/demokeystore.jks
          echo "✅ 密钥库已成功写入: ./keystore/demokeystore.jks"

      # 5. 验证密钥库和密码（可选但推荐）
      - name: Validate Keystore and Credentials
        run: |
          echo "验证密钥库、别名和密码..."
          echo "test" > dummy.txt
          zip -q dummy.jar dummy.txt
          rm dummy.txt

          if jarsigner -verify -verbose -keystore ./keystore/demokeystore.jks \
             -storepass "$STORE_PASSWORD" \
             -keypass "$KEY_PASSWORD" \
             dummy.jar "$KEY_ALIAS"; then
            echo "✅ 验证成功：密钥库、别名和密码均有效。"
            rm -f dummy.jar
          else
            echo "❌ 验证失败：请检查 KEYSTORE_BASE64, STORE_PASSWORD, KEY_PASSWORD, KEY_ALIAS 是否正确。"
            rm -f dummy.jar
            exit 1
          fi

      # 6. 为 Gradle 包装脚本添加执行权限
      - name: Make gradlew Executable
        run: chmod +x gradlew

      # 7. 构建 APK（核心步骤）
      - name: Build Signed APKs
        run: |
          echo "开始构建签名APK..."
          ./gradlew :app:assemble${{ github.event.inputs.buildVariant }} :wear:assemble${{ github.event.inputs.buildVariant }} \
            -Pandroid.injected.signing.store.file=./keystore/demokeystore.jks \
            -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          echo "✅ APK 构建完成。"

      # 8. 上传构建产物（APK文件）
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-aaps-apks
          path: |
            app/build/outputs/apk/
            wear/build/outputs/apk/
          retention-days: 7
