name: AAPS CI

on:
  workflow_dispatch:
    inputs:
      buildVariant:
        description: 'Select Build Variant'
        required: true
        default: 'fullRelease'
        type: choice
        options:
          - fullRelease
          - fullDebug
          - aapsclientRelease
          - aapsclientDebug
          - aapsclient2Release
          - aapsclient2Debug
          - pumpcontrolRelease
          - pumpcontrolDebug

jobs:
  build:
    name: Build AAPS
    runs-on: ubuntu-latest
    steps:
      # 1. è§£ç å¯†é’¥å¹¶åŠ è½½åˆ°ç¯å¢ƒå˜é‡
      - name: Decode Secrets Keystore Set and Oauth2 to Env
        run: |
          if [ -n "${{ secrets.KEYSTORE_SET }}" ]; then
            echo "ğŸ” Decoding KEYSTORE_SET..."
            DECODED=$(echo "${{ secrets.KEYSTORE_SET }}" | base64 -d)
            KEYSTORE_BASE64=$(echo "$DECODED" | cut -d'|' -f1)
            STORE_PASSWORD=$(echo "$DECODED" | cut -d'|' -f2)
            KEY_ALIAS=$(echo "$DECODED" | cut -d'|' -f3)
            KEY_PASSWORD=$(echo "$DECODED" | cut -d'|' -f4)
            echo "KEYSTORE_BASE64=$KEYSTORE_BASE64" >> $GITHUB_ENV
            echo "STORE_PASSWORD=$STORE_PASSWORD" >> $GITHUB_ENV
            echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
            echo "::add-mask::$KEYSTORE_BASE64"
            echo "::add-mask::$STORE_PASSWORD"
            echo "::add-mask::$KEY_ALIAS"
            echo "::add-mask::$KEY_PASSWORD"
            echo "âœ… Keystore parameters extracted from KEYSTORE_SET"
          else
            echo "â„¹ï¸ KEYSTORE_SET not provided, using separate secrets."
            echo "KEYSTORE_BASE64=${{ secrets.KEYSTORE_BASE64 }}" >> $GITHUB_ENV
            echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          fi

      # 2. æ£€æŸ¥å¿…è¦å¯†é’¥æ˜¯å¦å­˜åœ¨
      - name: Check Secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          MISSING=0
          check_secret() {
            if [ -z "$1" ]; then
              echo "âŒ Missing secret: $2"
              MISSING=1
            fi
          }
          check_secret "$KEYSTORE_BASE64" "KEYSTORE_BASE64"
          check_secret "$STORE_PASSWORD" "STORE_PASSWORD"
          check_secret "$KEY_ALIAS" "KEY_ALIAS"
          check_secret "$KEY_PASSWORD" "KEY_PASSWORD"
          if [ "$MISSING" -eq 1 ]; then
            echo "ğŸ›‘ Missing required secrets. Stopping build."
            exit 1
          fi
          echo "âœ… All required secrets are present."

      # 3. è·å–æºä»£ç 
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 4. åœ¨é¡¹ç›®ç›®å½•ä¸­è§£ç å¹¶åˆ›å»º keystore/demokeystore.jks æ–‡ä»¶
      - name: Decode keystore file and place at hardcoded project path
        run: |
          echo "æ­£åœ¨è§£ç å¯†é’¥åº“æ–‡ä»¶å¹¶åˆ›å»ºåˆ°é¡¹ç›®ç›®å½•..."
          mkdir -p ./keystore
          echo "$KEYSTORE_BASE64" | base64 -d > ./keystore/demokeystore.jks
          chmod 600 ./keystore/demokeystore.jks
          ls -la ./keystore/
          echo "âœ… å¯†é’¥åº“å·²æˆåŠŸå†™å…¥: ./keystore/demokeystore.jks"

      # 5. éªŒè¯å¯†é’¥åº“å’Œå¯†ç 
      - name: Validate Keystore and Credentials
        run: |
          echo "ğŸ” Validating keystore, alias and password..."
          echo "test" > dummy.txt
          zip -q dummy.jar dummy.txt
          rm dummy.txt

          if jarsigner -verify -verbose -keystore ./keystore/demokeystore.jks \
             -storepass "$STORE_PASSWORD" \
             -keypass "$KEY_PASSWORD" \
             dummy.jar "$KEY_ALIAS"; then
            echo "âœ… éªŒè¯æˆåŠŸï¼šå¯†é’¥åº“ã€åˆ«åå’Œå¯†ç å‡æœ‰æ•ˆã€‚"
            rm -f dummy.jar
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šè¯·æ£€æŸ¥ KEYSTORE_BASE64, STORE_PASSWORD, KEY_PASSWORD, KEY_ALIAS æ˜¯å¦æ­£ç¡®ã€‚"
            rm -f dummy.jar
            exit 1
          fi

      # 6. è®¾ç½® JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 7. ä¸º gradlew æ·»åŠ æ‰§è¡Œæƒé™
      - name: Make gradlew Executable
        run: chmod +x gradlew

      # 8. æ„å»º APK
      - name: Build APKs
        run: |
          echo "å¼€å§‹æ„å»ºç­¾åAPK..."
          ./gradlew :app:assemble${{ github.event.inputs.buildVariant }} :wear:assemble${{ github.event.inputs.buildVariant }} \
            -Pandroid.injected.signing.store.file=./keystore/demokeystore.jks \
            -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          echo "âœ… APK æ„å»ºå®Œæˆã€‚"

      # 9. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aaps-apks-${{ env.VERSION }}${{ env.VERSION_SUFFIX }}
          path: |
            app/build/outputs/apk/
            wear/build/outputs/apk/
          retention-days: 7
